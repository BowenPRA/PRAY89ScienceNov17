name: Update Lesson List

on:
  push:
    branches: [ main ]
  workflow_dispatch:

jobs:
  update-lessons:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v3
      
    - name: Set up Node.js
      uses: actions/setup-node@v3
      with:
        node-version: '18'
    
    - name: Generate lesson list
      run: |
        node << 'EOF'
        const fs = require('fs');
        const path = require('path');
        
        // Read all HTML files in the root directory
        const files = fs.readdirSync('.')
          .filter(file => file.endsWith('.html') && file !== 'index.html' && file !== 'lessons.html');
        
        const resources = [];
        
        // Parse each HTML file to extract lesson information
        files.forEach(filename => {
          const content = fs.readFileSync(filename, 'utf8');
          
          // Extract title from <title> tag
          const titleMatch = content.match(/<title>(.*?)<\/title>/);
          const title = titleMatch ? titleMatch[1] : filename.replace('.html', '');
          
          // Try to extract metadata from meta tags
          const descMatch = content.match(/<meta name="description" content="(.*?)"/);
          const description = descMatch ? descMatch[1] : '';
          
          // Extract subject from meta tag or filename
          let subject = 'Other';
          const subjectMatch = content.match(/<meta name="subject" content="(.*?)"/);
          if (subjectMatch) {
            subject = subjectMatch[1];
          } else if (filename.toLowerCase().includes('science')) {
            subject = 'Science';
          } else if (filename.toLowerCase().includes('math')) {
            subject = 'Math';
          } else if (filename.toLowerCase().includes('tech') || filename.toLowerCase().includes('computing')) {
            subject = 'Technology';
          }
          
          // Extract year from meta tag or filename
          let year = '';
          const yearMetaMatch = content.match(/<meta name="year" content="(.*?)"/);
          if (yearMetaMatch) {
            year = yearMetaMatch[1];
          } else {
            const yearMatch = filename.match(/Y(\d+)/i);
            if (yearMatch) {
              year = `Year ${yearMatch[1]}`;
            }
          }
          
          // Extract type from meta tag or default to lesson
          let type = 'lesson';
          const typeMatch = content.match(/<meta name="type" content="(.*?)"/);
          if (typeMatch) {
            type = typeMatch[1].toLowerCase();
          } else if (filename.toLowerCase().includes('game')) {
            type = 'game';
          } else if (filename.toLowerCase().includes('resource') || filename.toLowerCase().includes('handout')) {
            type = 'resource';
          }
          
          // Extract date from filename (assuming format like Y8ScienceNov17)
          let date = '';
          const dateMatch = filename.match(/([A-Z][a-z]{2})(\d{2})/);
          if (dateMatch) {
            const months = {
              'Jan': 'January', 'Feb': 'February', 'Mar': 'March',
              'Apr': 'April', 'May': 'May', 'Jun': 'June',
              'Jul': 'July', 'Aug': 'August', 'Sep': 'September',
              'Oct': 'October', 'Nov': 'November', 'Dec': 'December'
            };
            const month = months[dateMatch[1]] || dateMatch[1];
            const day = dateMatch[2];
            date = `${month} ${day}, 2025`;
          }
          
          // Also check for date meta tag
          const dateMetaMatch = content.match(/<meta name="date" content="(.*?)"/);
          if (dateMetaMatch) {
            date = dateMetaMatch[1];
          }
          
          // Extract tags
          const tags = [];
          
          // Check for tags meta tag
          const tagsMatch = content.match(/<meta name="tags" content="(.*?)"/);
          if (tagsMatch) {
            const metaTags = tagsMatch[1].split(',').map(t => t.trim());
            tags.push(...metaTags);
          }
          
          // Also check for data-tags attribute
          const dataTagsMatch = content.match(/data-tags="(.*?)"/);
          if (dataTagsMatch) {
            const dataTags = dataTagsMatch[1].split(',').map(t => t.trim());
            tags.push(...dataTags);
          }
          
          resources.push({
            filename,
            title,
            description,
            date,
            subject,
            year,
            type,
            tags
          });
        });
        
        // Sort resources by date (newest first)
        resources.sort((a, b) => {
          const dateA = new Date(a.date);
          const dateB = new Date(b.date);
          return dateB - dateA;
        });
        
        // Write resources to a JSON file
        fs.writeFileSync('resources.json', JSON.stringify(resources, null, 2));
        
        console.log(`Generated resources.json with ${resources.length} resources`);
        console.log(JSON.stringify(resources, null, 2));
        EOF
    
    - name: Update index.html
      run: |
        node << 'EOF'
        const fs = require('fs');
        
        // Read the resources data
        const resources = JSON.parse(fs.readFileSync('resources.json', 'utf8'));
        
        // Read the index.html file
        let indexContent = fs.readFileSync('index.html', 'utf8');
        
        // Replace the resources array in index.html
        const resourcesJson = JSON.stringify(resources, null, 12)
          .split('\n')
          .map((line, i) => i === 0 ? line : '            ' + line)
          .join('\n');
        
        const regex = /const resources = \[[\s\S]*?\];/;
        indexContent = indexContent.replace(regex, `const resources = ${resourcesJson};`);
        
        // Write the updated index.html
        fs.writeFileSync('index.html', indexContent);
        
        console.log('Updated index.html with resource data');
        EOF
    
    - name: Commit changes
      run: |
        git config --local user.email "github-actions[bot]@users.noreply.github.com"
        git config --local user.name "github-actions[bot]"
        git add resources.json index.html
        git diff --staged --quiet || git commit -m "Auto-update resource list"
        git push

permissions:
  contents: write
